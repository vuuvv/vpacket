# protocols.yaml

# --- 1. 数据结构库 (Data Structures Library) ---
data_structures:

  # 指令 0x01: 上报状态 (可复用结构)
  Cmd_01_Payload:
    fields:
      - name: "param_a"
        bits: 8
      - name: "temp_c"
        bits: 16
      - name: "is_valid"
        bits: 8

  # 默认结构：用于无法识别的指令 (可复用结构)
  Unknown_Payload:
    fields:
      - name: "raw_data_payload"
        type: "hex"
        size_expr: "int(vars.data_len) - 1"


# --- 2. 协议定义 (主流程) ---
protocols:
  - name: "CustomBoardBinary"
    type: "binary"

    framing_rule:
      header_marker: "7273"
      min_header_size: 24
      length_offset: 20
      length_size: 2
      length_adjustment: 24

    fields:
      - name: "magic"
        size: 2
        default: '7273'
        check: "fields.magic == '7273'"

      - name: "direction"
        default: 'BB'
        size: 1

      - name: "deviceId"
        size: 12

      - name: "productCode"
        default: '0000'
        size: 2

      - name: "versionRaw"
        default: '0000'
        size: 2

      - name: "command"
        size: 1

      - name: "dataLen"
        type: "int"
        size: 2

      - name: "dataCrc"
        crc: "crc16_modbus"
        crc_start: 24
        crc_end: "vars.packetLen"
        size: 2

      - type: "switch"
        field: "command"
        cases:
          - value: "02"
            fields:
              - name: "data.port"
                type: "uint"
                size: 1
              - name: "data.value"
                type: "uint"
                size: 1
          - value: "C3" # 刷卡信息上报
            flow: "decode" # 只用于解码流程
            fields:
              - name: "data.channel"
                type: "uint"
                size: 1
              - name: "data.idLen"
                type: "uint"
                size: 1
              - name: "data.cardNo"
                type: "string"
                size_expr: "fields.data.idLen"
              - name: "data.userRole"
                size: 1
                default: '00'
              - name: "data.room"
                size: 3
                default: '000000'
              - name: "data.startTime"
                size: 4
                default: '00000000'
              - name: "data.endTime"
                size: 4
                default: '00000000'
          - value: "FE" # 读取设备ID指令
            fields:
              - name: "data.success"
                flow: "decode" # 设备响应
                type: "uint"
                size: 1

        # 默认处理 (外部引用)
        default_ref: "Unknown_Payload"

  # --- 3. DTU 心跳协议 ---
  - name: "DTUHeartbeat"
    type: "text"

    framing_rule:
      start_delimiter: "s'['"
      end_delimiter: "s']'"
      max_len: 128
    fields:
      - name: "deviceId"
        type: "string"
        size: -1
      - name: "command"
        type: "calc"
        formula: "'heartbeat'"
      - name: "deviceType"
        type: "calc"
        formula: "'dtu'"
      - name: "connectionDevice"
        type: "calc"
        formula: "true"
