# protocols.yaml

# --- 1. 数据结构库 (Data Structures Library) ---
data_structures:

  # 指令 0x01: 上报状态 (可复用结构)
  Cmd_01_Payload:
    fields:
      - name: "param_a"
        bits: 8
      - name: "temp_c"
        bits: 16
      - name: "is_valid"
        bits: 8

  # 默认结构：用于无法识别的指令 (可复用结构)
  Unknown_Payload:
    fields:
      - name: "raw_data_payload"
        type: "hex"
        size_expr: "int(vars.data_len) - 1"


# --- 2. 协议定义 (主流程) ---
protocols:
  - name: "CustomBoardBinary"
    type: "binary"

    framing_rule:
      header_marker: "7273"
      min_header_size: 24
      length_offset: 20
      length_size: 2
      length_adjustment: 24

    fields:
      - name: "magic"
        size: 2
        check: "fields.magic == '7273'"

      - name: "direction"
        size: 1

      - name: "board_id"
        size: 12

      - name: "product_code"
        size: 2

      - name: "version_raw"
        size: 2

      - name: "hw_ver"
        type: "calc"
        formula: "int(fields.version_raw) / 256"
      - name: "sw_ver"
        type: "calc"
        formula: "int(fields.version_raw) % 256"

      - name: "command"
        size: 1

      - name: "data_len"
        type: "int"
        size: 2

      - name: "data_crc"
        crc: "crc16_modbus"
        crc_start: 24
        crc_end: "vars.packet_len"
        size: 2

      - type: "if"
        condition: "fields.data_len > 0"
        then:
          - name: "response_code"
            size: 1

          # 核心：混合模式 switch 结构
          - type: "switch"
            field: "command"
            cases:
              - value: "C3"
                fields:
                  - name: "id_len"
                    type: "uint"
                    size: 1
                  - name: "card_no"
                    type: "string"
                    size_expr: "fields.id_len"
                  - name: "user_role"
                    type: "uint"
                    size: 1
                  - name: "room"
                    size: 3
                  - name: "start_time"
                    size: 4
                  - name: "end_time"
                    size: 4



            # 默认处理 (外部引用)
            default_ref: "Unknown_Payload"

  # --- 3. DTU 心跳协议 ---
  - name: "DTUHeartbeat"
    type: "text"

    framing_rule:
      header_marker: "5B"
      start_delimiter: "["
      end_delimiter: "]"
      max_len: 128
    fields:
      - name: "content"
        type: "raw_text"