# protocols.yaml

# --- 1. 数据结构库 (Data Structures Library) ---
data_structures:

  # 指令 0x01: 上报状态 (可复用结构)
  ResponseCode:
    fields:
      - name: "data.code"
        flow: "decode"
        type: "uint"
        size: 1
      - name: "data.success"
        flow: "decode"
        type: "calc"
        formula: "fields.data.code==0"

  # 默认结构：用于无法识别的指令 (可复用结构)
  Unknown_Payload:
    fields:
      - name: "raw_data_payload"
        type: "hex"
        size_expr: "int(vars.data_len) - 1"


# --- 2. 协议定义 (主流程) ---
protocols:
  - name: "CustomBoardBinary"
    type: "binary"

    framing_rule:
      header_marker: "7273"
      min_header_size: 24
      length_offset: 20
      length_size: 2
      length_adjustment: 24

    fields:
      - name: "subDevice" # 表明是连接网关的子设备,不直接与服务器连接
        flow: "decode"
        type: "calc"
        formula: "true"
      - name: "magic"
        size: 2
        default: '7273'
        check: "fields.magic == '7273'"

      - name: "direction"
        default: 'AA'
        size: 1

      - name: "sn"
        size: 12

      - name: "productCode"
        default: '0000'
        size: 2

      - name: "versionRaw"
        default: '0000'
        size: 2

      - name: "command"
        size: 1

      - name: "dataLen"
        flow: "decode"
        type: "int"
        size: 2

      - name: "dataLen"
        flow: "encode"
        type: "calc"
        size: 2
        formula: "int(vars.packetLen) - int(offsets.dataStart)"
        round: 1

      - name: "dataCrc"
        crc: "crc16_modbus"
        crc_start: 24
        crc_end: "vars.packetLen"
        size: 2
        round: 1 # 表明到第二次编码过程中进行计算

      - type: "switch"
        name: "dataStart"
        field: "command"
        track_offset: true
        cases:
          - value: "01" # 读取IO状态
            fields:
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"
              - name: "data.ioState"
                type: "array"
                flow: "decode"
                size_expr: "(int(fields.dataLen) - 1) / 2"
                fields:
                  - name: "data.ioState.port"
                    type: "uint"
                    size: 1
                  - name: "data.ioState.value"
                    type: "uint"
                    size: 1
          - value: "02" # 输出IO
            fields:
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"
              - name: "data.port"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.value"
                flow: "encode"
                type: "uint"
                size: 1
          - value: "04" # 设置时间戳
            fields:
              - name: "data.timestamp"
                flow: "encode"
                type: "uint"
                size: 4
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"
          - value: "05" # 设置时间戳
            fields:
              - name: "data.index"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"
          - value: "0D" # 设置LED显示方向
            fields:
              - name: "data.direction"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"
          - value: "0E" # 设置LED显示方向
            fields:
              - name: "data.duration"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.line1Length"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.line1Speed"
                flow: "encode"
                type: "uint"
                size: 2
              - name: "data.line2Length"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.line2Speed"
                flow: "encode"
                type: "uint"
                size: 2
              - name: "data.line3Length"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.line3Speed"
                flow: "encode"
                type: "uint"
                size: 2
              - name: "data.line4Length"
                flow: "encode"
                type: "uint"
                size: 1
              - name: "data.line4Speed"
                flow: "encode"
                type: "uint"
                size: 2
              - name: "data.content"
                flow: "encode"
                type: "hex"
                size: -1
              - name: "data.response.code"
                type: "struct"
                flow: "decode"
                ref: "ResponseCode"

          - value: "C1" # 设备上报ID
            fields:
              - name: "data.code"
                flow: "decode"
                type: "uint"
                size_expr: "int(fields.dataLen)"
              - name: "data.code"
                flow: "encode"
                type: "uint"
                size: 1
          - value: "C2" # 设备上报IO状态,IO触发
            fields:
              - name: "data.ioState"
                type: "array"
                flow: "decode"
                size_expr: "int(fields.dataLen) / 2"
                fields:
                  - name: "data.ioState.port"
                    type: "uint"
                    size: 1
                  - name: "data.ioState.value"
                    type: "uint"
                    size: 1
              - name: "data.code"
                flow: "encode"
                type: "uint"
                size: 1
          - value: "C3" # 刷卡信息上报
            flow: "decode" # 只用于解码流程
            fields:
              - name: "data.channel"
                flow: "decode"
                type: "uint"
                size: 1
              - name: "data.idLen"
                flow: "decode"
                type: "uint"
                size: 1
              - name: "data.cardNo"
                flow: "decode"
                type: "string"
                size_expr: "fields.data.idLen"
              - name: "data.userRole"
                flow: "decode"
                size: 1
                default: '00'
              - name: "data.room"
                flow: "decode"
                size: 3
                default: '000000'
              - name: "data.startTime"
                flow: "decode"
                size: 4
                default: '00000000'
              - name: "data.endTime"
                flow: "decode"
                size: 4
                default: '00000000'
              - name: "data.code"
                flow: "encode"
                type: "uint"
                size: 1
          - value: "FE" # 读取设备ID指令
            fields:
              - name: "data.success"
                flow: "decode" # 设备响应
                type: "uint"
                size: 1

        # 默认处理 (外部引用)
        default_ref: "Unknown_Payload"

  # --- 3. DTU 心跳协议 ---
  - name: "DTUHeartbeat"
    type: "text"

    framing_rule:
      start_delimiter: "s'['"
      end_delimiter: "s']'"
      max_len: 128
    fields:
      - name: "sn"
        type: "string"
        size: -1
      - name: "command"
        type: "calc"
        formula: "'heartbeat'"
      - name: "deviceType"
        type: "calc"
        formula: "'dtu'"
